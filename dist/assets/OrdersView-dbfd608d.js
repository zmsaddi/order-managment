import{u as J,r as u,a as T,j as G,b as j,o as a,d as n,f as t,g as C,t as c,h as g,w as A,q as D,v as F,D as K,z as P,A as p,F as X,C as Y,n as Z}from"./vendor-24875fe8.js";import{_ as $,S as ee,s as L}from"./index-38f5e110.js";import{f as z,a as q,g as te,b as se}from"./formatters-b73e5c82.js";const oe={name:"OrdersView",components:{SidebarMenu:ee},setup(){const i=J(),e=u(!1),k=u(!0),s=u([]),b=u(""),h=u(""),x=u(""),w=u(""),_=u("created_at"),o=u("desc"),f=u(JSON.parse(localStorage.getItem("user")||"{}")),B=T(()=>["admin","sales_manager"].includes(f.value.role)),I=T(()=>{let l=s.value;if(b.value){const r=b.value.toLowerCase();l=l.filter(d=>d.customer_name.toLowerCase().includes(r)||d.id.toString().includes(r))}if(h.value&&(l=l.filter(r=>r.status===h.value)),x.value){const r=new Date(x.value);l=l.filter(d=>new Date(d.created_at)>=r)}if(w.value){const r=new Date(w.value);r.setHours(23,59,59,999),l=l.filter(d=>new Date(d.created_at)<=r)}return l=[...l].sort((r,d)=>{let m,v;switch(_.value){case"id":m=r.id,v=d.id;break;case"customer_name":m=r.customer_name.toLowerCase(),v=d.customer_name.toLowerCase();break;case"total":m=parseFloat(r.total),v=parseFloat(d.total);break;case"status":m=r.status,v=d.status;break;case"created_at":default:m=new Date(r.created_at).getTime(),v=new Date(d.created_at).getTime();break}return o.value==="asc"?m>v?1:m<v?-1:0:m<v?1:m>v?-1:0}),l}),H=()=>{e.value=!e.value},M=async()=>{k.value=!0;try{let l=L.from("orders").select("*").order("created_at",{ascending:!1});f.value.role==="representative"&&(l=l.eq("sales_rep_id",f.value.id));const{data:r,error:d}=await l;if(d)throw d;s.value=r||[]}catch(l){console.error("خطأ في جلب الطلبات:",l)}finally{k.value=!1}},N=()=>{b.value="",h.value="",x.value="",w.value="",M()},U=l=>B.value||f.value.id===l.sales_rep_id&&l.status==="new",S=u(!1),y=u(null),O=u(!1),Q=l=>{y.value=l,S.value=!0},V=()=>{S.value=!1,y.value=null},R=async()=>{if(y.value){O.value=!0;try{const{error:l}=await L.from("orders").delete().eq("id",y.value.id);if(l)throw l;s.value=s.value.filter(r=>r.id!==y.value.id),V()}catch(l){console.error("خطأ في حذف الطلب:",l),alert("حدث خطأ أثناء حذف الطلب. يرجى المحاولة مرة أخرى.")}finally{O.value=!1}}},W=l=>{const r=`
طلب رقم: ${l.id}
العميل: ${l.customer_name}
المنتج: ${l.product_description}
الكمية: ${l.quantity}
السعر: ${z(l.unit_price)}
الإجمالي: ${z(l.total)}
التاريخ: ${q(l.created_at)}
      `.trim(),d=encodeURIComponent(r);window.open(`https://wa.me/?text=${d}`,"_blank")},E=l=>{i.push({name:"order-details",params:{id:l.id},query:{invoice:"true"}})};return G(()=>{M()}),{user:f,isAdmin:B,showMobileSidebar:e,toggleSidebar:H,loading:k,orders:s,filteredOrders:I,searchQuery:b,statusFilter:h,dateFrom:x,dateTo:w,fetchOrders:M,resetFilters:N,formatCurrency:z,formatDate:q,getOrderStatusText:te,getOrderStatusClass:se,canDeleteOrder:U,showDeleteModal:S,orderToDelete:y,deleting:O,confirmDeleteOrder:Q,closeDeleteModal:V,deleteOrder:R,shareOnWhatsApp:W,generateInvoice:E}}},le={class:"min-h-screen bg-gray-50"},re={class:"flex h-screen overflow-hidden"},ae={class:"flex-1 flex flex-col overflow-hidden"},ne={class:"bg-white shadow-sm z-10"},ie={class:"flex items-center justify-between p-4"},de={class:"flex items-center"},ue={class:"flex items-center"},ce={class:"text-sm text-gray-600 ml-2"},me={class:"w-8 h-8 rounded-full bg-sky-500 flex items-center justify-center text-white"},ve={key:0,class:"fixed inset-0 z-20 md:hidden"},fe={class:"absolute inset-y-0 right-0 w-64 bg-sky-800 text-white"},ge={class:"p-4 border-b border-sky-700 flex justify-between items-center"},pe={class:"flex-1 overflow-y-auto p-4"},xe={class:"flex justify-between items-center mb-6"},we={class:"bg-white rounded-lg shadow-sm p-4 mb-6"},ye={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},be={class:"relative"},he={class:"flex justify-end mt-4"},ke={class:"bg-white rounded-lg shadow-sm overflow-hidden"},_e={key:0,class:"text-center py-8"},Ce={key:1,class:"text-center py-8"},De={key:0},Me={key:1},Se={key:2,class:"overflow-x-auto"},Oe={class:"w-full"},Fe={class:"bg-gray-50"},ze={key:0,class:"mr-1"},Be={key:0,class:"mr-1"},Ve={key:0,class:"mr-1"},Te={key:0,class:"mr-1"},je={key:0,class:"mr-1"},Ae={class:"divide-y divide-gray-200"},Le={class:"px-4 py-3 text-sm text-gray-900"},qe={class:"px-4 py-3 text-sm text-gray-900"},Ie={class:"px-4 py-3 text-sm text-gray-900"},He={class:"px-4 py-3 text-sm"},Ne={class:"px-4 py-3 text-sm text-gray-900"},Ue={class:"px-4 py-3 text-sm text-gray-900"},Qe={class:"flex space-x-2 space-x-reverse"},Re=["onClick"],We=["onClick"],Ee=["onClick"],Je={key:0,class:"fixed inset-0 z-30 overflow-y-auto"},Ge={class:"flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},Ke={class:"inline-block align-bottom bg-white rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"},Pe={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},Xe={class:"sm:flex sm:items-start"},Ye={class:"mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right"},Ze={class:"mt-2"},$e={class:"text-sm text-gray-500"},et={class:"mt-5 sm:mt-4 sm:flex sm:flex-row-reverse"},tt=["disabled"],st={key:0},ot={key:1};function lt(i,e,k,s,b,h){var _;const x=j("SidebarMenu"),w=j("router-link");return a(),n("div",le,[t("div",re,[C(x,{user:s.user},null,8,["user"]),t("div",ae,[t("header",ne,[t("div",ie,[t("div",de,[t("button",{onClick:e[0]||(e[0]=(...o)=>s.toggleSidebar&&s.toggleSidebar(...o)),class:"md:hidden ml-2"},e[17]||(e[17]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6h16M4 12h16M4 18h16"})],-1)])),e[18]||(e[18]=t("h2",{class:"text-xl font-semibold text-gray-800"},"الطلبات",-1))]),t("div",ue,[t("span",ce,c(s.user.name),1),t("div",me,c(s.user.name.charAt(0)),1)])])]),s.showMobileSidebar?(a(),n("div",ve,[t("div",{class:"absolute inset-0 bg-black opacity-50",onClick:e[1]||(e[1]=(...o)=>s.toggleSidebar&&s.toggleSidebar(...o))}),t("div",fe,[t("div",ge,[e[20]||(e[20]=t("h1",{class:"text-xl font-bold"},"نظام إدارة الطلبات",-1)),t("button",{onClick:e[2]||(e[2]=(...o)=>s.toggleSidebar&&s.toggleSidebar(...o))},e[19]||(e[19]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),C(x,{user:s.user,mobile:"",onItemClick:s.toggleSidebar},null,8,["user","onItemClick"])])])):g("",!0),t("main",pe,[t("div",xe,[e[22]||(e[22]=t("h1",{class:"text-2xl font-bold text-gray-800"},"إدارة الطلبات",-1)),C(w,{to:"/orders/create",class:"btn btn-primary flex items-center"},{default:A(()=>e[21]||(e[21]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 ml-1",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z","clip-rule":"evenodd"})],-1),p(" إضافة طلب جديد ")])),_:1,__:[21]})]),t("div",we,[t("div",ye,[t("div",null,[e[24]||(e[24]=t("label",{for:"search",class:"form-label"},"بحث",-1)),t("div",be,[D(t("input",{type:"text",id:"search","onUpdate:modelValue":e[3]||(e[3]=o=>s.searchQuery=o),placeholder:"اسم العميل، رقم الطلب...",class:"form-input pr-8"},null,512),[[F,s.searchQuery]]),e[23]||(e[23]=t("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z","clip-rule":"evenodd"})])],-1))])]),t("div",null,[e[26]||(e[26]=t("label",{for:"status-filter",class:"form-label"},"الحالة",-1)),D(t("select",{id:"status-filter","onUpdate:modelValue":e[4]||(e[4]=o=>s.statusFilter=o),class:"form-input"},e[25]||(e[25]=[P('<option value="" data-v-9cfa330e>جميع الحالات</option><option value="new" data-v-9cfa330e>جديد</option><option value="completed_pending_delivery" data-v-9cfa330e>مكتمل بانتظار التسليم</option><option value="delivered" data-v-9cfa330e>تم التسليم</option><option value="cancelled" data-v-9cfa330e>ملغى</option>',5)]),512),[[K,s.statusFilter]])]),t("div",null,[e[27]||(e[27]=t("label",{for:"date-from",class:"form-label"},"من تاريخ",-1)),D(t("input",{type:"date",id:"date-from","onUpdate:modelValue":e[5]||(e[5]=o=>s.dateFrom=o),class:"form-input"},null,512),[[F,s.dateFrom]])]),t("div",null,[e[28]||(e[28]=t("label",{for:"date-to",class:"form-label"},"إلى تاريخ",-1)),D(t("input",{type:"date",id:"date-to","onUpdate:modelValue":e[6]||(e[6]=o=>s.dateTo=o),class:"form-input"},null,512),[[F,s.dateTo]])])]),t("div",he,[t("button",{onClick:e[7]||(e[7]=(...o)=>s.resetFilters&&s.resetFilters(...o)),class:"btn bg-gray-200 text-gray-800 hover:bg-gray-300 ml-2"}," إعادة تعيين "),t("button",{onClick:e[8]||(e[8]=(...o)=>s.fetchOrders&&s.fetchOrders(...o)),class:"btn btn-primary"}," تطبيق الفلتر ")])]),t("div",ke,[s.loading?(a(),n("div",_e,e[29]||(e[29]=[t("p",null,"جاري تحميل البيانات...",-1)]))):s.filteredOrders.length===0?(a(),n("div",Ce,[s.searchQuery||s.statusFilter||s.dateFrom||s.dateTo?(a(),n("p",De,"لا توجد نتائج مطابقة للبحث")):(a(),n("p",Me,"لا توجد طلبات"))])):(a(),n("div",Se,[t("table",Oe,[t("thead",null,[t("tr",Fe,[t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer",onClick:e[9]||(e[9]=o=>i.sortBy("id"))},[e[30]||(e[30]=p(" رقم الطلب ")),i.sortField==="id"?(a(),n("span",ze,c(i.sortDirection==="asc"?"▲":"▼"),1)):g("",!0)]),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer",onClick:e[10]||(e[10]=o=>i.sortBy("customer_name"))},[e[31]||(e[31]=p(" العميل ")),i.sortField==="customer_name"?(a(),n("span",Be,c(i.sortDirection==="asc"?"▲":"▼"),1)):g("",!0)]),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer",onClick:e[11]||(e[11]=o=>i.sortBy("total"))},[e[32]||(e[32]=p(" المبلغ ")),i.sortField==="total"?(a(),n("span",Ve,c(i.sortDirection==="asc"?"▲":"▼"),1)):g("",!0)]),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer",onClick:e[12]||(e[12]=o=>i.sortBy("status"))},[e[33]||(e[33]=p(" الحالة ")),i.sortField==="status"?(a(),n("span",Te,c(i.sortDirection==="asc"?"▲":"▼"),1)):g("",!0)]),t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer",onClick:e[13]||(e[13]=o=>i.sortBy("created_at"))},[e[34]||(e[34]=p(" التاريخ ")),i.sortField==="created_at"?(a(),n("span",je,c(i.sortDirection==="asc"?"▲":"▼"),1)):g("",!0)]),e[35]||(e[35]=t("th",{class:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"},"الإجراءات",-1))])]),t("tbody",Ae,[(a(!0),n(X,null,Y(s.filteredOrders,o=>(a(),n("tr",{key:o.id,class:"hover:bg-gray-50"},[t("td",Le,"#"+c(o.id),1),t("td",qe,c(o.customer_name),1),t("td",Ie,c(s.formatCurrency(o.total)),1),t("td",He,[t("span",{class:Z([s.getOrderStatusClass(o.status),"px-2 py-1 text-xs rounded-full"])},c(s.getOrderStatusText(o.status)),3)]),t("td",Ne,c(s.formatDate(o.created_at)),1),t("td",Ue,[t("div",Qe,[C(w,{to:`/orders/${o.id}`,class:"text-sky-600 hover:text-sky-800",title:"عرض التفاصيل"},{default:A(()=>e[36]||(e[36]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{d:"M10 12a2 2 0 100-4 2 2 0 000 4z"}),t("path",{"fill-rule":"evenodd",d:"M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z","clip-rule":"evenodd"})],-1)])),_:2,__:[36]},1032,["to"]),t("button",{onClick:f=>s.shareOnWhatsApp(o),class:"text-green-600 hover:text-green-800",title:"مشاركة عبر واتساب"},e[37]||(e[37]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{d:"M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"})],-1)]),8,Re),t("button",{onClick:f=>s.generateInvoice(o),class:"text-purple-600 hover:text-purple-800",title:"إنشاء فاتورة"},e[38]||(e[38]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z","clip-rule":"evenodd"})],-1)]),8,We),s.canDeleteOrder(o)?(a(),n("button",{key:0,onClick:f=>s.confirmDeleteOrder(o),class:"text-red-600 hover:text-red-800",title:"حذف"},e[39]||(e[39]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)]),8,Ee)):g("",!0)])])]))),128))])])]))])])])]),s.showDeleteModal?(a(),n("div",Je,[t("div",Ge,[t("div",{class:"fixed inset-0 transition-opacity",onClick:e[14]||(e[14]=(...o)=>s.closeDeleteModal&&s.closeDeleteModal(...o))},e[40]||(e[40]=[t("div",{class:"absolute inset-0 bg-gray-500 opacity-75"},null,-1)])),t("div",Ke,[t("div",Pe,[t("div",Xe,[e[44]||(e[44]=t("div",{class:"mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})])],-1)),t("div",Ye,[e[43]||(e[43]=t("h3",{class:"text-lg font-medium text-gray-900"},"تأكيد الحذف",-1)),t("div",Ze,[t("p",$e,[p(' هل أنت متأكد من رغبتك في حذف الطلب رقم "'+c((_=s.orderToDelete)==null?void 0:_.id)+'"؟ ',1),e[41]||(e[41]=t("br",null,null,-1)),e[42]||(e[42]=p(" لا يمكن التراجع عن هذا الإجراء. "))])])])]),t("div",et,[t("button",{type:"button",class:"btn btn-danger w-full sm:w-auto sm:mr-3",onClick:e[15]||(e[15]=(...o)=>s.deleteOrder&&s.deleteOrder(...o)),disabled:s.deleting},[s.deleting?(a(),n("span",st,"جاري الحذف...")):(a(),n("span",ot,"حذف"))],8,tt),t("button",{type:"button",class:"btn bg-gray-200 text-gray-800 hover:bg-gray-300 mt-3 w-full sm:mt-0 sm:w-auto",onClick:e[16]||(e[16]=(...o)=>s.closeDeleteModal&&s.closeDeleteModal(...o))}," إلغاء ")])])])])])):g("",!0)])}const it=$(oe,[["render",lt],["__scopeId","data-v-9cfa330e"]]);export{it as default};
