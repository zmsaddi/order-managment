import{u as O,i as P,r as g,E as B,j as z,b as U,o as c,d as p,f as t,g as x,t as V,h as C,w as q,l as D,A as f,q as u,v as m,F as H,C as N,D as T}from"./vendor-24875fe8.js";import{_ as L,S as A,s as y}from"./index-38f5e110.js";import{f as R}from"./formatters-b73e5c82.js";const J={name:"EditOrderView",components:{SidebarMenu:A},setup(){const S=O(),e=P(),w=g(!1),o=g(!0),h=g(!1),M=g(JSON.parse(localStorage.getItem("user")||"{}")),l=B({id:null,customer_name:"",customer_phone:"",customer_address:"",notes:"",status:"new",tax_rate:0,tax_amount:0,subtotal:0,total:0,sales_rep_id:null}),i=g([]),s=()=>{w.value=!w.value},d=a=>{const n=i.value[a];n.subtotal=parseFloat(n.quantity)*parseFloat(n.unit_price),r()},r=()=>{l.subtotal=i.value.reduce((a,n)=>a+parseFloat(n.subtotal||0),0),l.tax_amount=l.subtotal*(parseFloat(l.tax_rate)/100),l.total=l.subtotal+l.tax_amount},F=()=>{const a=i.value.length>0?Math.max(...i.value.map(n=>n.id))+1:1;i.value.push({id:a,description:"",notes:"",quantity:1,unit_price:0,subtotal:0}),r()},I=a=>{i.value.length>1&&(i.value.splice(a,1),r())},j=async()=>{try{o.value=!0;const a=e.params.id,{data:n,error:k}=await y.from("orders").select("*").eq("id",a).single();if(k)throw k;if(!n){console.error("لم يتم العثور على الطلب");return}Object.assign(l,n);const{data:v,error:b}=await y.from("order_products").select("*").eq("order_id",a);if(b)throw b;v&&v.length>0?i.value=v.map(_=>({id:_.id,description:_.description,notes:_.notes||"",quantity:_.quantity,unit_price:_.unit_price,subtotal:_.subtotal})):i.value=[{id:1,description:n.product_description||"",notes:n.product_notes||"",quantity:n.quantity||1,unit_price:n.unit_price||0,subtotal:n.subtotal||0}],r()}catch(a){console.error("خطأ في جلب بيانات الطلب:",a)}finally{o.value=!1}},E=async()=>{try{h.value=!0,r();const{error:a}=await y.from("orders").update({customer_name:l.customer_name,customer_phone:l.customer_phone,customer_address:l.customer_address,subtotal:parseFloat(l.subtotal),tax_rate:parseFloat(l.tax_rate),tax_amount:parseFloat(l.tax_amount),total:parseFloat(l.total),notes:l.notes,status:l.status}).eq("id",l.id);if(a)throw a;const{error:n}=await y.from("order_products").delete().eq("order_id",l.id);if(n)throw n;const k=i.value.map(b=>({order_id:l.id,name:b.description||"منتج بدون اسم",description:b.description||"منتج بدون وصف",notes:b.notes||"",quantity:parseFloat(b.quantity),unit_price:parseFloat(b.unit_price),subtotal:parseFloat(b.subtotal)})),{error:v}=await y.from("order_products").insert(k);if(v)throw v;S.push({name:"order-details",params:{id:l.id}})}catch(a){console.error("خطأ في تحديث الطلب:",a),alert("حدث خطأ أثناء تحديث الطلب. يرجى المحاولة مرة أخرى.")}finally{h.value=!1}};return z(()=>{j()}),{user:M,showMobileSidebar:w,toggleSidebar:s,loading:o,updating:h,order:l,products:i,calculateProductSubtotal:d,calculateTotals:r,addProduct:F,removeProduct:I,updateOrder:E,formatCurrency:R}}},G={class:"min-h-screen bg-gray-50"},K={class:"flex h-screen overflow-hidden"},Q={class:"flex-1 flex flex-col overflow-hidden"},W={class:"bg-white shadow-sm z-10"},X={class:"flex items-center justify-between p-4"},Y={class:"flex items-center"},Z={class:"flex items-center"},$={class:"text-sm text-gray-600 ml-2"},tt={class:"w-8 h-8 rounded-full bg-sky-500 flex items-center justify-center text-white"},et={key:0,class:"fixed inset-0 z-20 md:hidden"},ot={class:"absolute inset-y-0 right-0 w-64 bg-sky-800 text-white"},st={class:"p-4 border-b border-sky-700 flex justify-between items-center"},lt={class:"flex-1 overflow-y-auto p-4"},rt={key:0,class:"text-center py-8"},nt={key:1,class:"text-center py-8"},at={key:2},dt={class:"flex justify-between items-center mb-6"},it={class:"text-2xl font-bold text-gray-800"},ut={class:"bg-white rounded-lg shadow-sm p-6"},mt={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},ct={class:"col-span-1 md:col-span-2"},pt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},bt={class:"col-span-1 md:col-span-2"},ft={class:"flex justify-between items-center mb-2"},vt={class:"text-md font-semibold text-gray-700"},_t={class:"flex space-x-2 space-x-reverse"},gt=["onClick"],xt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},yt=["for"],wt=["id","onUpdate:modelValue"],ht=["for"],kt=["id","onUpdate:modelValue"],Vt={class:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-3"},qt=["for"],St=["id","onUpdate:modelValue","onInput"],Mt=["for"],Ut={class:"relative"},Ct=["id","onUpdate:modelValue","onInput"],Ft=["for"],It={class:"relative"},jt=["id","onUpdate:modelValue"],Et={class:"mt-2"},Ot={class:"grid grid-cols-1 gap-4"},Pt={class:"relative"},Bt={class:"relative"},zt={class:"relative"},Dt={class:"grid grid-cols-1 gap-4"},Ht={class:"mt-8 flex justify-end"},Nt=["disabled"],Tt={key:0},Lt={key:1};function At(S,e,w,o,h,M){const l=U("SidebarMenu"),i=U("router-link");return c(),p("div",G,[t("div",K,[x(l,{user:o.user},null,8,["user"]),t("div",Q,[t("header",W,[t("div",X,[t("div",Y,[t("button",{onClick:e[0]||(e[0]=(...s)=>o.toggleSidebar&&o.toggleSidebar(...s)),class:"md:hidden ml-2"},e[15]||(e[15]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6h16M4 12h16M4 18h16"})],-1)])),e[16]||(e[16]=t("h2",{class:"text-xl font-semibold text-gray-800"},"تعديل الطلب",-1))]),t("div",Z,[t("span",$,V(o.user.name),1),t("div",tt,V(o.user.name.charAt(0)),1)])])]),o.showMobileSidebar?(c(),p("div",et,[t("div",{class:"absolute inset-0 bg-black opacity-50",onClick:e[1]||(e[1]=(...s)=>o.toggleSidebar&&o.toggleSidebar(...s))}),t("div",ot,[t("div",st,[e[18]||(e[18]=t("h1",{class:"text-xl font-bold"},"نظام إدارة الطلبات",-1)),t("button",{onClick:e[2]||(e[2]=(...s)=>o.toggleSidebar&&o.toggleSidebar(...s))},e[17]||(e[17]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),x(l,{user:o.user,mobile:"",onItemClick:o.toggleSidebar},null,8,["user","onItemClick"])])])):C("",!0),t("main",lt,[o.loading?(c(),p("div",rt,e[19]||(e[19]=[t("p",null,"جاري تحميل البيانات...",-1)]))):o.order.id?(c(),p("div",at,[t("div",dt,[t("h1",it,"تعديل الطلب رقم #"+V(o.order.id),1),x(i,{to:`/orders/${o.order.id}`,class:"btn bg-gray-200 text-gray-800 hover:bg-gray-300 flex items-center"},{default:q(()=>e[22]||(e[22]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 ml-1",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1),f(" العودة إلى تفاصيل الطلب ")])),_:1,__:[22]},8,["to"])]),t("div",ut,[t("form",{onSubmit:e[14]||(e[14]=D((...s)=>o.updateOrder&&o.updateOrder(...s),["prevent"]))},[t("div",mt,[t("div",ct,[e[26]||(e[26]=t("h2",{class:"text-lg font-semibold text-gray-800 mb-4"},"بيانات العميل",-1)),t("div",pt,[t("div",null,[e[23]||(e[23]=t("label",{for:"customer_name",class:"form-label"},[f("اسم العميل "),t("span",{class:"text-red-500"},"*")],-1)),u(t("input",{type:"text",id:"customer_name","onUpdate:modelValue":e[3]||(e[3]=s=>o.order.customer_name=s),class:"form-input text-center",required:""},null,512),[[m,o.order.customer_name]])]),t("div",null,[e[24]||(e[24]=t("label",{for:"customer_phone",class:"form-label"},"رقم الهاتف",-1)),u(t("input",{type:"text",id:"customer_phone","onUpdate:modelValue":e[4]||(e[4]=s=>o.order.customer_phone=s),class:"form-input text-center"},null,512),[[m,o.order.customer_phone]])]),t("div",null,[e[25]||(e[25]=t("label",{for:"customer_address",class:"form-label"},"العنوان",-1)),u(t("input",{type:"text",id:"customer_address","onUpdate:modelValue":e[5]||(e[5]=s=>o.order.customer_address=s),class:"form-input text-center"},null,512),[[m,o.order.customer_address]])])])]),t("div",bt,[e[34]||(e[34]=t("h2",{class:"text-lg font-semibold text-gray-800 mb-4"},"بيانات المنتجات",-1)),(c(!0),p(H,null,N(o.products,(s,d)=>(c(),p("div",{key:s.id,class:"mb-4 p-4 border border-gray-200 rounded-lg"},[t("div",ft,[t("h3",vt,"المنتج "+V(d+1),1),t("div",_t,[o.products.length>1?(c(),p("button",{key:0,type:"button",onClick:r=>o.removeProduct(d),class:"text-red-600 hover:text-red-800",title:"حذف المنتج"},e[27]||(e[27]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)]),8,gt)):C("",!0)])]),t("div",xt,[t("div",null,[t("label",{for:"product_description_"+d,class:"form-label"},e[28]||(e[28]=[f("وصف المنتج "),t("span",{class:"text-red-500"},"*",-1)]),8,yt),u(t("textarea",{id:"product_description_"+d,"onUpdate:modelValue":r=>s.description=r,class:"form-input text-center",rows:"2",required:""},null,8,wt),[[m,s.description]])]),t("div",null,[t("label",{for:"product_notes_"+d,class:"form-label"},"ملاحظات المنتج",8,ht),u(t("textarea",{id:"product_notes_"+d,"onUpdate:modelValue":r=>s.notes=r,class:"form-input text-center",rows:"2",placeholder:"أي ملاحظات إضافية خاصة بالمنتج"},null,8,kt),[[m,s.notes]])])]),t("div",Vt,[t("div",null,[t("label",{for:"quantity_"+d,class:"form-label"},e[29]||(e[29]=[f("الكمية "),t("span",{class:"text-red-500"},"*",-1)]),8,qt),u(t("input",{type:"number",id:"quantity_"+d,"onUpdate:modelValue":r=>s.quantity=r,class:"form-input text-center",min:"0.01",step:"0.01",required:"",onInput:r=>o.calculateProductSubtotal(d)},null,40,St),[[m,s.quantity]])]),t("div",null,[t("label",{for:"unit_price_"+d,class:"form-label"},e[30]||(e[30]=[f("سعر الوحدة "),t("span",{class:"text-red-500"},"*",-1)]),8,Mt),t("div",Ut,[u(t("input",{type:"number",id:"unit_price_"+d,"onUpdate:modelValue":r=>s.unit_price=r,class:"form-input text-center pr-8",min:"0.01",step:"0.01",required:"",onInput:r=>o.calculateProductSubtotal(d)},null,40,Ct),[[m,s.unit_price]]),e[31]||(e[31]=t("div",{class:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"},[t("span",{class:"text-gray-500"},"€")],-1))])]),t("div",null,[t("label",{for:"subtotal_"+d,class:"form-label"},"المجموع",8,Ft),t("div",It,[u(t("input",{type:"number",id:"subtotal_"+d,"onUpdate:modelValue":r=>s.subtotal=r,class:"form-input text-center pr-8",readonly:""},null,8,jt),[[m,s.subtotal]]),e[32]||(e[32]=t("div",{class:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"},[t("span",{class:"text-gray-500"},"€")],-1))])])])]))),128)),t("div",Et,[t("button",{type:"button",onClick:e[6]||(e[6]=(...s)=>o.addProduct&&o.addProduct(...s)),class:"btn bg-sky-100 text-sky-800 hover:bg-sky-200 flex items-center"},e[33]||(e[33]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 ml-1",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z","clip-rule":"evenodd"})],-1),f(" إضافة منتج آخر ")]))])]),t("div",null,[e[43]||(e[43]=t("h2",{class:"text-lg font-semibold text-gray-800 mb-4"},"الإجماليات والملاحظات",-1)),t("div",Ot,[t("div",null,[e[36]||(e[36]=t("label",{for:"subtotal",class:"form-label"},"المجموع الفرعي",-1)),t("div",Pt,[u(t("input",{type:"number",id:"subtotal","onUpdate:modelValue":e[7]||(e[7]=s=>o.order.subtotal=s),class:"form-input text-center pr-8",readonly:""},null,512),[[m,o.order.subtotal]]),e[35]||(e[35]=t("div",{class:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"},[t("span",{class:"text-gray-500"},"€")],-1))])]),t("div",null,[e[37]||(e[37]=t("label",{for:"tax_rate",class:"form-label"},"نسبة الضريبة (%)",-1)),u(t("input",{type:"number",id:"tax_rate","onUpdate:modelValue":e[8]||(e[8]=s=>o.order.tax_rate=s),class:"form-input text-center",min:"0",step:"0.01",onInput:e[9]||(e[9]=(...s)=>o.calculateTotals&&o.calculateTotals(...s))},null,544),[[m,o.order.tax_rate]])]),t("div",null,[e[39]||(e[39]=t("label",{for:"tax_amount",class:"form-label"},"مبلغ الضريبة",-1)),t("div",Bt,[u(t("input",{type:"number",id:"tax_amount","onUpdate:modelValue":e[10]||(e[10]=s=>o.order.tax_amount=s),class:"form-input text-center pr-8",readonly:""},null,512),[[m,o.order.tax_amount]]),e[38]||(e[38]=t("div",{class:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"},[t("span",{class:"text-gray-500"},"€")],-1))])]),t("div",null,[e[41]||(e[41]=t("label",{for:"total",class:"form-label"},"الإجمالي",-1)),t("div",zt,[u(t("input",{type:"number",id:"total","onUpdate:modelValue":e[11]||(e[11]=s=>o.order.total=s),class:"form-input text-center pr-8 font-bold",readonly:""},null,512),[[m,o.order.total]]),e[40]||(e[40]=t("div",{class:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"},[t("span",{class:"text-gray-500"},"€")],-1))])]),t("div",null,[e[42]||(e[42]=t("label",{for:"notes",class:"form-label"},"ملاحظات الطلب",-1)),u(t("textarea",{id:"notes","onUpdate:modelValue":e[12]||(e[12]=s=>o.order.notes=s),class:"form-input text-center",rows:"3",placeholder:"أي ملاحظات إضافية خاصة بالطلب بشكل عام"},null,512),[[m,o.order.notes]])])])]),t("div",null,[e[46]||(e[46]=t("h2",{class:"text-lg font-semibold text-gray-800 mb-4"},"حالة الطلب",-1)),t("div",Dt,[t("div",null,[e[45]||(e[45]=t("label",{for:"status",class:"form-label"},[f("الحالة "),t("span",{class:"text-red-500"},"*")],-1)),u(t("select",{id:"status","onUpdate:modelValue":e[13]||(e[13]=s=>o.order.status=s),class:"form-input text-center",required:""},e[44]||(e[44]=[t("option",{value:"new"},"جديد",-1),t("option",{value:"completed_pending_delivery"},"مكتمل بانتظار التسليم",-1),t("option",{value:"delivered"},"تم التسليم",-1),t("option",{value:"cancelled"},"ملغى",-1)]),512),[[T,o.order.status]])])])])]),t("div",Ht,[x(i,{to:`/orders/${o.order.id}`,class:"btn bg-gray-200 text-gray-800 hover:bg-gray-300 ml-2"},{default:q(()=>e[47]||(e[47]=[f(" إلغاء ")])),_:1,__:[47]},8,["to"]),t("button",{type:"submit",class:"btn btn-primary",disabled:o.updating},[o.updating?(c(),p("span",Tt,"جاري الحفظ...")):(c(),p("span",Lt,"حفظ التغييرات"))],8,Nt)])],32)])])):(c(),p("div",nt,[e[21]||(e[21]=t("p",null,"لم يتم العثور على الطلب",-1)),x(i,{to:"/orders",class:"btn btn-primary mt-4"},{default:q(()=>e[20]||(e[20]=[f("العودة إلى الطلبات")])),_:1,__:[20]})]))])])])])}const Kt=L(J,[["render",At],["__scopeId","data-v-fc0d9c61"]]);export{Kt as default};
